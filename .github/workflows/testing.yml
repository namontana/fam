name: ðŸ§ª Comprehensive Testing

on:
  push:
    branches: [ main, develop, 'feature/**', 'hotfix/**' ]
    paths:
      - 'mobile_app/montanagent/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'mobile_app/montanagent/**'
  schedule:
    # Run tests every day at 2 AM UTC
    - cron: '0 2 * * *'

env:
  FLUTTER_VERSION: '3.24.3'
  WORKING_DIRECTORY: ./mobile_app/montanagent

jobs:
  # Unit Tests
  unit-tests:
    name: ðŸ”¬ Unit Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: ðŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ðŸ“¦ Install dependencies
        run: flutter pub get

      - name: ðŸ§ª Run unit tests
        run: |
          flutter test \
            --coverage \
            --test-randomize-ordering-seed random \
            --reporter github \
            test/unit/

      - name: ðŸ“Š Generate coverage report
        run: |
          # Install lcov for coverage reporting
          sudo apt-get update
          sudo apt-get install -y lcov
          
          # Generate HTML coverage report
          genhtml coverage/lcov.info -o coverage/html
          
          # Generate coverage summary
          lcov --summary coverage/lcov.info

      - name: ðŸ“¤ Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ${{ env.WORKING_DIRECTORY }}/coverage/
          retention-days: 7

      - name: ðŸ“Š Upload to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ${{ env.WORKING_DIRECTORY }}/coverage/lcov.info
          flags: unit-tests
          name: unit-tests-coverage

  # Widget Tests
  widget-tests:
    name: ðŸŽ¨ Widget Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: ðŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ðŸ“¦ Install dependencies
        run: flutter pub get

      - name: ðŸŽ¨ Run widget tests
        run: |
          flutter test \
            --coverage \
            --test-randomize-ordering-seed random \
            --reporter github \
            test/widget/

      - name: ðŸ“Š Upload to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ${{ env.WORKING_DIRECTORY }}/coverage/lcov.info
          flags: widget-tests
          name: widget-tests-coverage

  # Integration Tests
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: ðŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ðŸ“¦ Install dependencies
        run: flutter pub get

      - name: ðŸ”— Run integration tests
        run: |
          flutter test \
            --coverage \
            --test-randomize-ordering-seed random \
            --reporter github \
            integration_test/

      - name: ðŸ“Š Upload to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ${{ env.WORKING_DIRECTORY }}/coverage/lcov.info
          flags: integration-tests
          name: integration-tests-coverage

  # Performance Tests
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: ðŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ðŸ“¦ Install dependencies
        run: flutter pub get

      - name: âš¡ Run performance tests
        run: |
          flutter test \
            --reporter github \
            test/performance/

      - name: ðŸ“Š Benchmark app size
        run: |
          flutter build web --release
          echo "## ðŸ“Š Build Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Size |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | $(du -sh build/web | cut -f1) |" >> $GITHUB_STEP_SUMMARY

  # Test Matrix for Multiple Flutter Versions
  compatibility-tests:
    name: ðŸ”„ Compatibility Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        flutter-version: ['3.22.0', '3.24.3']
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    steps:
      - name: ðŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ¦ Setup Flutter ${{ matrix.flutter-version }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-version }}
          cache: true

      - name: ðŸ“¦ Install dependencies
        run: flutter pub get

      - name: ðŸ§ª Run compatibility tests
        run: flutter test --reporter github

  # Test Results Summary
  test-summary:
    name: ðŸ“‹ Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, widget-tests, integration-tests, performance-tests, compatibility-tests]
    if: always()
    
    steps:
      - name: ðŸ“š Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: ./coverage/

      - name: ðŸ“Š Create test summary
        run: |
          echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Widget Tests | ${{ needs.widget-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Tests | ${{ needs.performance-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compatibility Tests | ${{ needs.compatibility-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š [View detailed coverage report](https://codecov.io/gh/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”” Notify test results
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: 'ðŸš¨ Test suite failed for MontaNAgent!'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}